name: Deploy Node.js App with Docker to EC2

on:
  push:
    branches: [main] # Trigger on push to the master branch

jobs:
  deploy:
    runs-on: ubuntu-latest # Run the workflow on an Ubuntu runner

    steps:
    - uses: actions/checkout@v3 # Checkout the repository code

    - name: Configure AWS credentials (replace with your approach)
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }} # Replace with secret name
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }} # Replace with secret name
        AWS_DEFAULT_REGION: us-west-1 # Replace with your region if needed
      run: |
        echo "AWS credentials configured (placeholders for security)"

    - name: Use AWS CLI (optional, replace with appropriate tool)
      uses: aws-actions/aws-cli@v2
      with:
        aws-version: '2.28.0' # Adjust version as needed
        region: us-west-1 # Replace with your region if needed
        commands: |
          aws ec2 describe-instances  # Replace with desired AWS CLI command

    - name: print out example job
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ inputs.hostname }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: ${{ secrets.PORT }}
        command_timeout: 30m
        script: |
          echo "Nice Job!!!"
          sudo apt-get update
          curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          sudo apt-get install -y docker.io
          sudo usermod -aG docker $USER
          sudo systemctl restart docker
          curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o docker-compose
          chmod +x docker-compose
          sudo mv docker-compose /usr/local/bin/docker-compose
          git clone https://github.com/edencoania/nodejs_with_dbs.git
          cd nodejs_with_dbs
          docker-compose -f composedb/stack.yml up -d
          npm install
          npm start


    - name: Build and deploy Node.js application with Docker (replace with commands)
      run: |
        echo "Building and deploying Node.js application with Docker (replace with commands)"
        # Replace with commands for building Docker image and deploying to EC2

    - name: Clean up (optional)
      run: |
        echo "Cleaning up (optional)"
        # Add commands to clean up temporary files or resources on the EC2 instance
