name: Deploy Node.js App with Docker to EC2

on:
  push:
    branches: [main] # Trigger on push to the master branch

jobs:
  deploy:
    runs-on: ubuntu-latest # Run the workflow on an Ubuntu runner

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2


    - name: copy file to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ec2-54-153-76-140.us-west-1.compute.amazonaws.com
        username: ubuntu
        key: ${{ secrets.KEY }}
        port: 22
        source: composedb/stack.yml
        target: your_server_target_folder_path

        name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      -
        name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: user/app:latest

      - name: Pull Docker image from ECR (consider building and pushing image in a separate job)
        run: |
          docker login -u AWS -p $AWS_ECR_PASSWORD $AWS_ECR_URI  # Replace with your ECR credentials
          docker pull $ECR_IMAGE_URI:<image_tag>              # Replace with your image URI and tag

    - name: executing remote ssh commands using ssh key
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ec2-54-153-76-140.us-west-1.compute.amazonaws.com
        username: ubuntu
        key: ${{ secrets.KEY }}
        port: 22
        script: |
          ls -a
          pwd
          sudo apt-get update
          curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y docker.io
          sudo usermod -aG docker $USER
          sudo systemctl restart docker
          curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o docker-compose
          chmod +x docker-compose
          sudo mv docker-compose /usr/local/bin/docker-compose
          docker-compose -f composedb/stack.yml up -d
          sleep 30

    - name: copy file to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ec2-54-153-76-140.us-west-1.compute.amazonaws.com
        username: ubuntu
        key: ${{ secrets.KEY }}
        port: 22
        source: composedb/stack.yml
        target: your_server_target_folder_path
